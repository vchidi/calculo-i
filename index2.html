<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>InPen</title>

<style>
body{font-family:-apple-system,system-ui,Segoe UI,Arial;margin:8px;background:#f9f9f9;font-size:15px}
.box{background:white;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
h3{margin:4px 0 6px;font-size:16px}
label{font-weight:600;font-size:14px}
input,select,button{width:100%;padding:6px;margin-top:4px;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{background:#007aff;color:white;border:none}
.small{background:#eee;color:black}
.row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.big{font-size:20px;font-weight:700}
.gray{color:#666}
.red{color:#c00;font-weight:600}
pre{background:#f3f3f3;padding:6px;border-radius:8px;font-size:13px}
.top{display:flex;gap:6px}
.top button{flex:1}
</style>
</head>

<body>

<div class="box top">
  <button class="small" onclick="location.href='index1.html'">Val</button>
  <button class="small" onclick="location.href='index0.html'">Menú</button>
</div>

<div class="box">
<h3>Comida</h3>
<select id="meal"></select>

<div class="row">
<div>
<div class="gray">hc/i</div>
<div class="big" id="rNow"></div>
</div>
<div>
<div class="gray">Sens</div>
<div class="big" id="sNow"></div>
</div>
</div>
</div>

<div class="box">
<h3>Editar</h3>
<div class="row">
<input id="rEdit">
<input id="sEdit">
</div>
<button id="save">Guardar</button>
</div>

<div class="box">
<h3>Datos</h3>

<label>GOAL</label>
<input id="goal">

<label>Glucosa</label>
<input id="g">

<label>Raciones</label>
<input id="h">

<button id="calc">Calcular</button>

<div id="err" class="red"></div>

<div class="gray">i</div>
<div class="big" id="iRaw">—</div>

<button id="round">Redondear 0.5</button>

<div class="gray">Final</div>
<div class="big" id="iRound">—</div>
</div>

<script>
const GOAL="goal_glucose";

const def={
  Desayuno:{r:3.8,s:17},
  Snack:{r:4.5,s:20.5},
  Lunch:{r:6.9,s:31},
  Merienda:{r:8,s:36},
  Cena:{r:6.9,s:31}
};

const meal=document.getElementById("meal");
const rNow=document.getElementById("rNow");
const sNow=document.getElementById("sNow");
const rEdit=document.getElementById("rEdit");
const sEdit=document.getElementById("sEdit");
const goal=document.getElementById("goal");
const g=document.getElementById("g");
const h=document.getElementById("h");
const err=document.getElementById("err");
const iRaw=document.getElementById("iRaw");
const iRound=document.getElementById("iRound");

function num(v){return Number(String(v??"").replace(",","."));}

function getGoal(){return Number(localStorage.getItem(GOAL))||100;}

function load(m){
  return {
    r:Number(localStorage.getItem("r_"+m))||def[m].r,
    s:Number(localStorage.getItem("s_"+m))||def[m].s
  };
}

function save(m,r,s){
  localStorage.setItem("r_"+m,r);
  localStorage.setItem("s_"+m,s);
}

Object.keys(def).forEach(m=>{
  const o=document.createElement("option");
  o.value=m;o.textContent=m;meal.appendChild(o);
});

goal.value=getGoal();

function refresh(){
  const p=load(meal.value);
  rNow.textContent=p.r.toFixed(2);
  sNow.textContent=p.s.toFixed(1);
  rEdit.value=p.r;
  sEdit.value=p.s;
}

meal.onchange=refresh;

document.getElementById("save").onclick=()=>{
  const r=num(rEdit.value);
  const s=num(sEdit.value);
  if(!isFinite(r)||!isFinite(s))return;
  save(meal.value,r,s);
  refresh();
};

let last=NaN;

document.getElementById("calc").onclick=()=>{
  err.textContent="";
  const G=num(goal.value);
  const gg=num(g.value);
  const hh=num(h.value);
  const p=load(meal.value);

  if(!isFinite(G)||!isFinite(gg)||!isFinite(hh)){
    err.textContent="Datos inválidos";return;
  }

  localStorage.setItem(GOAL,G);

  last=hh/p.r+(gg-G)/p.s;

  iRaw.textContent=last.toFixed(2);
  iRound.textContent="—";
};

document.getElementById("round").onclick=()=>{
  if(!isFinite(last))return;
  iRound.textContent=(Math.round(last*2)/2).toFixed(1);
};

refresh();
</script>

</body>
</html>
