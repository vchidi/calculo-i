<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cálculo i (hc/i)</title>
<style>
  body{font-family:-apple-system,system-ui,Segoe UI,Arial;margin:8px;background:#f9f9f9;font-size:15px}
  .box{background:#fff;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
  h3{margin:4px 0 6px;font-size:16px}
  label{font-weight:600;font-size:14px}
  input,select,button{width:100%;padding:6px;margin-top:4px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#007aff;color:#fff;border:none}
  .smallBtn{background:#eee;color:#000;margin-top:4px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .big{font-size:20px;font-weight:700}
  .gray{color:#666}
  .red{color:#c00;font-weight:600}
  pre{background:#f3f3f3;padding:6px;border-radius:8px;font-size:13px;white-space:pre-wrap;word-break:break-word}
  .topRow{display:flex;gap:6px}
  .topRow button{flex:1}
</style>
</head>
<body>

<div class="box">
  <div class="topRow">
    <button class="smallBtn" onclick="location.href='index0.html'">⬅ Menú</button>
    <button class="smallBtn" onclick="location.href='index1.html'">Mi Método</button>
  </div>
</div>

<div class="box">
  <h3>Comida</h3>
  <select id="meal"></select>

  <div class="row" style="margin-top:6px;">
    <div>
      <div class="gray">hc/i (raciones/u)</div>
      <div class="big" id="ratioNow">—</div>
    </div>
    <div>
      <div class="gray">Sensibilidad</div>
      <div class="big" id="sensNow">—</div>
    </div>
  </div>
</div>

<div class="box">
  <h3>Editar</h3>
  <div class="row">
    <div>
      <label>hc/i</label>
      <input id="ratioEdit" inputmode="decimal" placeholder="Ej: 3.8">
    </div>
    <div>
      <label>Sensibilidad</label>
      <input id="sensEdit" inputmode="decimal" placeholder="Ej: 17">
    </div>
  </div>

  <div class="row" style="margin-top:6px;">
    <button id="saveParams">Guardar</button>
    <button id="resetParams" class="smallBtn">Reset</button>
  </div>
</div>

<div class="box">
  <h3>Datos</h3>

  <label>Objetivo (GOAL)</label>
  <input id="goal" inputmode="decimal" placeholder="Ej: 100">

  <label>Glucosa (g)</label>
  <input id="g" inputmode="decimal" placeholder="Ej: 130">

  <label>Raciones (h)</label>
  <input id="h" inputmode="decimal" placeholder="Ej: 2.5">

  <button id="calcI">Calcular i</button>

  <div id="err" class="red" style="margin-top:6px;"></div>

  <div style="margin-top:6px;">
    <div class="gray">i sin redondear</div>
    <div class="big" id="iRaw">—</div>
  </div>

  <button id="applyRound" style="margin-top:6px;">Redondear (0.5)</button>

  <div style="margin-top:6px;">
    <div class="gray">i final</div>
    <div class="big" id="iRound">—</div>
  </div>
</div>

<div class="box">
  <h3>Operación</h3>
  <pre id="op">Introduce datos</pre>
</div>

<div class="box">
  <h3>Probar otra i</h3>
  <label><input type="checkbox" id="tryOther"> Activar</label>

  <div id="otherBox" style="display:none;margin-top:6px;">
    <input id="iSug" inputmode="decimal" placeholder="Mi i">
    <button id="calcRatio">Calcular hc/i resultante</button>

    <div style="margin-top:6px;">
      <div class="gray">hc/i resultante</div>
      <div class="big" id="ratioSug">—</div>
    </div>
  </div>
</div>

<script>
const GOAL_KEY = "goal_glucose";

const defaults = {
  "Desayuno": { ratio: 3.8, sens: 17.0 },
  "Snack": { ratio: 4.5, sens: 20.5 },
  "Lunch": { ratio: 6.9, sens: 31.0 },
  "Merienda": { ratio: 8.0, sens: 36.0 },
  "Cena": { ratio: 6.9, sens: 31.0 }
};

const meal = document.getElementById("meal");
const ratioNow = document.getElementById("ratioNow");
const sensNow = document.getElementById("sensNow");

const ratioEdit = document.getElementById("ratioEdit");
const sensEdit = document.getElementById("sensEdit");
const saveParams = document.getElementById("saveParams");
const resetParams = document.getElementById("resetParams");

const goalEl = document.getElementById("goal");
const gEl = document.getElementById("g");
const hEl = document.getElementById("h");

const calcI = document.getElementById("calcI");
const err = document.getElementById("err");
const iRawEl = document.getElementById("iRaw");
const iRoundEl = document.getElementById("iRound");
const applyRound = document.getElementById("applyRound");
const op = document.getElementById("op");

const tryOther = document.getElementById("tryOther");
const otherBox = document.getElementById("otherBox");
const iSug = document.getElementById("iSug");
const calcRatio = document.getElementById("calcRatio");
const ratioSug = document.getElementById("ratioSug");

function num(v){ return Number(String(v ?? "").replace(",", ".")); }
function curMeal(){ return meal.value; }
function getGoal(){ return Number(localStorage.getItem(GOAL_KEY)) || 100; }
function setGoal(v){ localStorage.setItem(GOAL_KEY, String(v)); }

function loadParams(m){
  const r = localStorage.getItem("ratio_" + m);
  const s = localStorage.getItem("sens_" + m);
  return {
    ratio: (r !== null) ? Number(r) : defaults[m].ratio,
    sens:  (s !== null) ? Number(s) : defaults[m].sens
  };
}

function saveParamsFor(m, ratio, sens){
  localStorage.setItem("ratio_" + m, String(ratio));
  localStorage.setItem("sens_" + m, String(sens));
}

function resetParamsFor(m){
  localStorage.removeItem("ratio_" + m);
  localStorage.removeItem("sens_" + m);
}

function updateUI(){
  const p = loadParams(curMeal());
  ratioNow.textContent = p.ratio.toFixed(2);
  sensNow.textContent = p.sens.toFixed(1);
  ratioEdit.value = p.ratio.toFixed(2);
  sensEdit.value = p.sens.toFixed(1);
  updateOp();
}

function updateOp(){
  const goal = num(goalEl.value);
  const g = num(gEl.value);
  const h = num(hEl.value);
  const p = loadParams(curMeal());

  if(!isFinite(goal) || !isFinite(g) || !isFinite(h) || !isFinite(p.ratio) || !isFinite(p.sens) || p.ratio === 0 || p.sens === 0){
    op.textContent = "Introduce GOAL, g y h (y que hc/i y sensibilidad no sean 0).";
    return;
  }

  const bolusComida = h / p.ratio;
  const correccion = (g - goal) / p.sens;
  const i = bolusComida + correccion;

  op.textContent =
`i = h/(hc/i) + (g-GOAL)/sens

i = ${h} / ${p.ratio.toFixed(2)} + (${g.toFixed(1)} - ${goal.toFixed(1)}) / ${p.sens.toFixed(1)}
i = ${bolusComida.toFixed(3)} + ${correccion.toFixed(3)}
i = ${i.toFixed(3)}`;
}

// Populate meals
Object.keys(defaults).forEach(name => {
  const o = document.createElement("option");
  o.value = name;
  o.textContent = name;
  meal.appendChild(o);
});

// Init GOAL shared
goalEl.value = String(getGoal());

// Events
meal.addEventListener("change", () => { err.textContent=""; updateUI(); });

saveParams.addEventListener("click", () => {
  err.textContent = "";
  const m = curMeal();
  const r = num(ratioEdit.value);
  const s = num(sensEdit.value);
  if(!isFinite(r) || r === 0){ err.textContent="hc/i inválido (0)"; return; }
  if(!isFinite(s) || s === 0){ err.textContent="sensibilidad inválida (0)"; return; }
  saveParamsFor(m, r, s);
  updateUI();
});

resetParams.addEventListener("click", () => {
  err.textContent = "";
  resetParamsFor(curMeal());
  updateUI();
});

goalEl.addEventListener("input", () => {
  const v = num(goalEl.value);
  if(isFinite(v)) setGoal(v);
  updateOp();
});

gEl.addEventListener("input", updateOp);
hEl.addEventListener("input", updateOp);

let lastI = NaN;

calcI.addEventListener("click", () => {
  err.textContent = "";
  ratioSug.textContent = "—";

  const goal = num(goalEl.value);
  const g = num(gEl.value);
  const h = num(hEl.value);
  const p = loadParams(curMeal());

  if(!isFinite(goal) || !isFinite(g) || !isFinite(h)){ err.textContent="Datos inválidos"; return; }
  if(!isFinite(p.ratio) || p.ratio === 0){ err.textContent="hc/i inválido (0)"; return; }
  if(!isFinite(p.sens) || p.sens === 0){ err.textContent="sensibilidad inválida (0)"; return; }

  lastI = (h / p.ratio) + ((g - goal) / p.sens);

  iRawEl.textContent = lastI.toFixed(2);
  iRoundEl.textContent = "—";
  updateOp();
});

applyRound.addEventListener("click", () => {
  if(!isFinite(lastI)) return;
  const r = Math.round(lastI * 2) / 2;
  iRoundEl.textContent = r.toFixed(1);
});

tryOther.addEventListener("change", () => {
  otherBox.style.display = tryOther.checked ? "block" : "none";
});

// ratio resultante con i sugerida (manteniendo g, h, sens):
// i = h/ratio + (g-goal)/sens  =>  ratio = h / ( i - (g-goal)/sens )
calcRatio.addEventListener("click", () => {
  err.textContent = "";
  const goal = num(goalEl.value);
  const g = num(gEl.value);
  const h = num(hEl.value);
  const i = num(iSug.value);
  const p = loadParams(curMeal());

  if(!isFinite(goal) || !isFinite(g) || !isFinite(h) || !isFinite(i)){ err.textContent="Datos inválidos"; return; }
  if(!isFinite(p.sens) || p.sens === 0){ err.textContent="sensibilidad inválida (0)"; return; }

  const correccion = (g - goal) / p.sens;
  const denom = (i - correccion);
  if(denom === 0){ err.textContent="Con esa i, denominador 0."; return; }

  const ratio = h / denom;
  ratioSug.textContent = ratio.toFixed(2);
  updateOp();
});

// Init
updateUI();
</script>

</body>
</html>
