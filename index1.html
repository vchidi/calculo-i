<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Val</title>

<style>
body{font-family:-apple-system,system-ui,Segoe UI,Arial;margin:8px;background:#f9f9f9;font-size:15px}
.box{background:white;border-radius:10px;padding:8px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
h3{margin:4px 0 6px;font-size:16px}
label{font-weight:600;font-size:14px}
input,select,button{width:100%;padding:6px;margin-top:4px;border-radius:8px;border:1px solid #ccc;font-size:15px}
button{background:#007aff;color:white;border:none}
.small{background:#eee;color:black}
.row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.big{font-size:20px;font-weight:700}
.gray{color:#666}
.red{color:#c00;font-weight:600}
pre{background:#f3f3f3;padding:6px;border-radius:8px;font-size:13px}
.top{display:flex;gap:6px}
.top button{flex:1}
</style>
</head>

<body>

<div class="box top">
  <button class="small" onclick="location.href='index0.html'">Menú</button>
  <button class="small" onclick="location.href='index2.html'">InPen</button>
</div>

<div class="box">
<h3>Comida (t)</h3>
<select id="meal"></select>
<div class="big">t = <span id="tNow"></span></div>
</div>

<div class="box">
<h3>Editar t</h3>
<div class="row">
<input id="tEdit">
<button id="saveT">Guardar</button>
</div>
</div>

<div class="box">
<h3>Datos</h3>

<label>GOAL</label>
<input id="goal">

<label>Glucosa</label>
<input id="g">

<label>Raciones</label>
<input id="h">

<button id="calc">Calcular</button>

<div id="err" class="red"></div>

<div class="gray">i</div>
<div class="big" id="iRaw">—</div>

<button id="round">Redondear 0.5</button>

<div class="gray">Final</div>
<div class="big" id="iRound">—</div>
</div>

<div class="box">
<h3>Operación</h3>
<pre id="op"></pre>
</div>

<script>
const GOAL="goal_glucose";

const def={Desayuno:1.8,Snack:1.6,Lunch:1.35,Merienda:1.35,Cena:1};

const meal=document.getElementById("meal");
const tNow=document.getElementById("tNow");
const tEdit=document.getElementById("tEdit");
const goal=document.getElementById("goal");
const g=document.getElementById("g");
const h=document.getElementById("h");
const err=document.getElementById("err");
const iRaw=document.getElementById("iRaw");
const iRound=document.getElementById("iRound");
const op=document.getElementById("op");

function num(v){return Number(String(v??"").replace(",","."));}

function getGoal(){return Number(localStorage.getItem(GOAL))||100;}

function loadT(m){
  return Number(localStorage.getItem("t_"+m))||def[m];
}

function saveT(m,v){
  localStorage.setItem("t_"+m,v);
}

Object.keys(def).forEach(m=>{
  const o=document.createElement("option");
  o.value=m;o.textContent=m;meal.appendChild(o);
});

goal.value=getGoal();

function refresh(){
  const t=loadT(meal.value);
  tNow.textContent=t.toFixed(2);
  tEdit.value=t.toFixed(2);
}

meal.onchange=refresh;

document.getElementById("saveT").onclick=()=>{
  const v=num(tEdit.value);
  if(!isFinite(v))return;
  saveT(meal.value,v);
  refresh();
};

let last=NaN;

document.getElementById("calc").onclick=()=>{
  err.textContent="";
  const G=num(goal.value);
  const gg=num(g.value);
  const hh=num(h.value);
  const t=loadT(meal.value);

  if(!isFinite(G)||!isFinite(gg)||!isFinite(hh)){
    err.textContent="Datos inválidos";return;
  }

  localStorage.setItem(GOAL,G);

  last=t*hh+(gg-G)/30;

  iRaw.textContent=last.toFixed(2);
  iRound.textContent="—";

  op.textContent=
`i = ${t}×${hh} + (${gg}-${G})/30
i = ${last.toFixed(3)}`;
};

document.getElementById("round").onclick=()=>{
  if(!isFinite(last))return;
  iRound.textContent=(Math.round(last*2)/2).toFixed(1);
};

refresh();
</script>

</body>
</html>
